<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>考勤管理系统</title>
   <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
   <script src="https://cdn1.lncld.net/static/js/3.15.0/av-min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
       html,body { height:100%; margin:0; padding:0; }
body { min-height: 100vh; background:#f5f7fa; margin:0; display: flex; flex-direction: column; }
.container { flex:1 0 0; min-height:0; height: 100vh; display:flex; flex-direction:column;}
.main-content { flex:1 1 0; min-height:0; display:flex; }
.content { flex:1 1 0; min-height:0; overflow-y: auto; }
.page { min-height:0; }
.content-section { margin-bottom:12px; }

.header { background:#3498db; color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;}
.header h1 { font-size:28px; font-weight:bold;}
.header-actions { display:flex; gap:15px;}
.main-content { display:flex; flex:1 1 0; min-height:200px;}
.sidebar { width: 250px; background: #2c3e50; color:#ecf0f1; padding: 20px 0; flex-shrink: 0;}
.sidebar-header { padding: 0 20px 20px; border-bottom:1px solid #34495e; margin-bottom:20px;}
.sidebar-header h2 { font-size:22px;}
.menu-item { padding: 12px 20px; cursor: pointer; transition:all 0.3s; display:flex; align-items:center; gap:10px;}
.menu-item:hover { background: #34495e;}
.menu-item.active { background: #3498db; border-left: 4px solid #ecf0f1;}
.menu-item i { font-size:18px;}
.content { flex: 1; padding: 20px; overflow-x: hidden; min-width:0;}
.content-section { background:white; border-radius:5px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:20px;}
.table-container {
    width: 100%;
    max-width: 100vw;
    overflow-x: auto;
    overflow-y: hidden;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    background: #fff;
    padding-bottom: 8px;
}

table {
    border-collapse: collapse;
    margin: 0;
    width: max-content;
    min-width: 800px;
    white-space: nowrap;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    height: 20px;
    vertical-align: middle;
}
#summary-row td {
    height: 80px;
    font-size: 15px;
    vertical-align: middle;
}
.attendance-toolbar .control-panel {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    gap: 8px;
    margin-bottom: 0;
    align-items: center;
}
.attendance-toolbar .control-item {
    flex-direction: row !important;
    align-items: center !important;
    gap: 4px;
    margin-bottom: 0;
}
.attendance-toolbar label {
    margin-right: 4px;
}
.attendance-toolbar select,
.attendance-toolbar input[type="file"],
.attendance-toolbar button {
    height: 30px;
    font-size: 15px;
}
th, td { font-size: 15px;}
th.date, td.date { min-width: 100px; max-width:100px;}
th.week, td.week { min-width: 70px; max-width:70px;}
th.am, td.am,
th.pm, td.pm,
th.ot, td.ot { min-width: 60px; max-width:60px;}
th.staff-title, td.staff-title { min-width: 180px;}
.attendance-cell { cursor:pointer; transition:all 0.2s;}
.attendance-cell:hover { background-color: #f0f7ff;}
.holiday { background-color: #ffeaa7; color: #d63031; font-weight:bold;}
.overtime { background-color: #d1ecf1; color: #0c5460;}
.leave { background-color: #f8d7da; color: #721c24;}
.pleaseleave { background-color: #fffbe6; color: #bfa900;}
.page { display: none;}
.page.active { display: block;}
button { background-color:#3498db;color:white;border:none;padding:12px 18px;border-radius:4px;cursor:pointer;margin-right:10px;font-size:16px;transition:all 0.3s;}
button:hover { background-color:#2980b9; transform: translateY(-2px);}
button.export-btn { background-color:#27ae60;}
button.export-btn:hover { background-color:#219653;}
button.delete-btn { background-color:#e74c3c;}
button.delete-btn:hover { background-color:#c0392b;}
.control-panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center;}
.control-item { display: flex; flex-direction: column; }
@font-face {
    font-family: 'Material Icons'; font-style: normal; font-weight: 400;
    src: url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
}
.material-icons {
    font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: 24px;
    line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block;
    white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-feature-settings: 'liga';
    -webkit-font-smoothing: antialiased;
}
.staff-list { margin-top: 20px;}
.staff-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
.staff-item:hover { background-color: #f9f9f9; }
.staff-info { flex: 1; }
.staff-actions { display: flex; gap: 10px; }
@media (max-width: 768px) {
    .main-content { flex-direction: column; }
    .sidebar { width: 100%; }
    .content { padding: 10px; }
    .control-panel { flex-direction: column; align-items: stretch; }
}
.badge-ban {
    position: absolute;
    top: -5px;
    right: -7px;
    background: #fff;
    border-radius: 50%;
    border: 2px solid #d63031;
    color: #d63031;
    font-weight: bold;
    font-size: 11px;
    width: 15px;
    height: 15px;
    line-height: 10px;
    text-align: center;
    display: inline-block;
    z-index: 2;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.week-cell-wrap {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: relative;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航 -->
        <div class="header">
            <h1>考勤管理系统</h1>
            <div class="header-actions"></div>
        </div>
        <div class="main-content">
            <!-- 侧边栏 -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>功能菜单</h2>
                </div>
                <div class="menu-item active" data-page="dashboard">
                    <i class="material-icons">dashboard</i> 仪表盘
                </div>
                <div class="menu-item" data-page="staff">
                    <i class="material-icons">people</i> 人员管理
                </div>
                <div class="menu-item" data-page="attendance">
                    <i class="material-icons">calendar_today</i> 考勤表管理
                </div>
                <div class="menu-item" data-page="salary">
                    <i class="material-icons">attach_money</i> 工资表管理
                </div>
            </div>
            <div class="content">
                <div id="dashboard" class="page active">
                    <div class="content-section">
                        <h2>欢迎使用考勤管理系统</h2>
                        <p>用于公司员工考勤、工资、数据导入导出和公司多账户管理。</p>
                        <div style="display: flex; margin-top: 20px; flex-wrap: wrap; gap: 15px;">
                            <div style="flex: 1; min-width: 200px; padding: 20px; background: #e3f2fd; border-radius: 5px;">
                                <h3>员工总数</h3>
                                <p id="staff-count" style="font-size: 32px; font-weight: bold; margin: 10px 0;">0</p>
                            </div>
                            <div style="flex: 1; min-width: 200px; padding: 20px; background: #fff3e0; border-radius: 5px;">
                                <h3>公司名称</h3>
                                <p id="company-name" style="font-size: 20px; font-weight: bold; margin: 10px 0;">宁德市品诚模具配件有限公司</p>
                            </div>
                        </div>
                    </div>
                    <div class="content-section">
                        <h2>快速操作</h2>
                        <div style="display: flex; gap: 15px; margin-top: 15px;">
                            <button onclick="switchPage('attendance')">
                                <i class="material-icons">calendar_today</i> 管理考勤表
                            </button>
                            <button onclick="switchPage('staff')">
                                <i class="material-icons">people</i> 管理员工
                            </button>
                            <button class="export-btn" onclick="exportToExcel()">
                                <i class="material-icons">description</i> 导出当前考勤表
                            </button>
                        </div>
                    </div>
                </div>
                <div id="attendance" class="page">
                    <div class="content-section" style="padding: 12px 20px 10px 20px; margin-bottom: 10px;">
                        <h2 style="display:inline-block; font-size:18px; margin-right:20px;">考勤表管理</h2>
                        <label style="margin-right:8px;">年份</label>
                        <select id="year-select" onchange="loadAttendanceTable()" style="margin-right:12px; height:32px;"></select>
                        <label style="margin-right:8px;">月份</label>
                        <select id="month-select" onchange="loadAttendanceTable()" style="margin-right:12px; height:32px;">
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" style="margin-right: 12px; height: 32px; vertical-align:middle;" multiple>
                        <button onclick="importExcel()" style="height:32px; vertical-align:middle; padding: 0 15px;">
                            <i class="material-icons" style="vertical-align:middle;">file_upload</i> 导入数据
                        </button>
                        <button class="export-btn" onclick="exportToExcel()" style="height:32px; vertical-align:middle; padding: 0 15px; margin-left: 8px;">
                            <i class="material-icons" style="vertical-align:middle;">description</i> 导出考勤表
                        </button>
                    </div>
                    <div class="content-section" style="padding:8px 20px 10px 20px; margin-bottom:0;">
                        <div class="table-container">
                            <table id="attendance-table">
                                <thead></thead>
                                <tbody></tbody>
                                <tfoot>
                                    <tr id="summary-row"></tr>
                                    <tr id="signature-row"></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="staff" class="page">
                    <div class="content-section">
                        <h2>人员管理</h2>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="display: flex; margin-bottom: 10px;">
                                <input type="text" id="staff-search" placeholder="搜索员工姓名" style="margin-right: 10px; padding: 10px; width: 250px;">
                                <button onclick="searchStaff()">
                                    <i class="material-icons">search</i> 搜索
                                </button>
                            </div>
                            <button onclick="showAddStaffModal()">
                                <i class="material-icons">person_add</i> 添加新员工
                            </button>
                        </div>
                        <div class="staff-list" id="staff-list"></div>
                    </div>
                </div>
                <div id="salary" class="page">
                    <div class="content-section">
                        <h2>工资表管理</h2>
                        <div class="control-panel">
                            <div class="control-item">
                                <label>选择年份</label>
                                <select id="salary-year-select"></select>
                            </div>
                            <div class="control-item">
                                <label>选择月份</label>
                                <select id="salary-month-select"></select>
                            </div>
                            <div class="control-item" style="justify-content: flex-end;">
                                <button onclick="exportSalaryExcel()"><i class="material-icons">file_download</i> 导出工资表</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="salary-table">
                                <thead>
                                    <tr>
                                        <th>姓名</th>
                                        <th>部门</th>
                                        <th>职位</th>
                                        <th>基本工资</th>
                                        <th>绩效</th>
                                        <th>补贴</th>
                                        <th>考勤扣款</th>
                                        <th>实发工资</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="add-staff-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.36); z-index:9999; align-items:center; justify-content:center;">
          <div class="modal-content" style="background:#fff; border-radius:8px; padding:32px 28px 24px 28px; width:340px; max-width:98vw; box-shadow:0 8px 32px rgba(0,0,0,0.13); position:relative;">
            <span class="modal-close" onclick="hideAddStaffModal()" style="position:absolute; top:18px; right:18px; font-size:24px; color:#aaa; cursor:pointer;">&times;</span>
            <h2 id="staff-modal-title" style="margin-top:0;">添加新员工</h2>
            <div class="form-group">
              <label>姓名</label>
              <input type="text" id="staff-name" style="width:100%;padding:8px;">
            </div>
            <div class="form-group">
              <label>部门</label>
              <select id="staff-department" style="width:100%;padding:8px;">
                <option value=""></option>
                <option value="技术部">技术部</option>
                <option value="销售部">销售部</option>
                <option value="市场部">市场部</option>
                <option value="人事部">人事部</option>
                <option value="财务部">财务部</option>
              </select>
            </div>
            <div class="form-group">
              <label>职位</label>
              <input type="text" id="staff-position" style="width:100%;padding:8px;">
            </div>
            <div class="form-group">
              <label>基本工资（元）</label>
              <input type="number" id="staff-base-salary" min="0" style="width:100%;padding:8px;">
            </div>
            <div style="display:flex; gap:12px; margin-top:18px;">
              <button id="save-staff-btn" style="flex:1;">
                <i class="material-icons">save</i> 保存
              </button>
              <button onclick="hideAddStaffModal()" style="background:#eee; color:#555; flex:1;">
                <i class="material-icons">cancel</i> 取消
              </button>
            </div>
          </div>
        </div>
    </div>

<script>
//--- LeanCloud 初始化 ---
AV.init({
    appId: 'k3cDCOEFE1fx9kDWaErGEOBz-gzGzoHsz',
    appKey: 'EUtgeFJQhCdlKguaHcmf4RjH',
    serverURLs: "https://k3cdcoef.lc-cn-n1-shared.com"
});
const STAFF_CLASS = 'Staff';
const ATTENDANCE_CLASS = 'Attendance';
const SALARY_CLASS = 'Salary';
const companyName = "宁德市品诚模具配件有限公司";
let staffData = [];
let attendanceData = {}; // {'2025-09': {staffId: {day: {...}}}}
let salaryData = {};

const holidays = {
    '2025-04-04': '清明',
    '2025-05-01': '劳动节',
    '2025-06-20': '端午节',
    '2025-10-01': '国庆节',
    '2025-10-02': '国庆节',
    '2025-10-03': '国庆节',
    '2025-10-04': '国庆节',
    '2025-10-05': '国庆节',
    '2025-10-06': '国庆节',
    '2025-10-07': '国庆节',
    '2025-10-08': '国庆节'
};
const makeUpWorkDay = '2025-10-12';

function lc2obj(obj) {
    if (!obj) return null;
    let json = obj.toJSON ? obj.toJSON() : {};
    json.objectId = obj.id || obj.objectId;
    return json;
}

// 员工相关
async function fetchStaffData() {
    const query = new AV.Query(STAFF_CLASS);
    query.ascending("createdAt");
    staffData = (await query.find()).map(lc2obj);
    document.getElementById('staff-count').textContent = staffData.length;
    renderStaffList();
}
async function addStaff() {
    const name = document.getElementById('staff-name').value;
    const department = document.getElementById('staff-department').value;
    const position = document.getElementById('staff-position').value;
    const baseSalary = parseFloat(document.getElementById('staff-base-salary').value) || 0;
    if (!name) { alert('请输入员工姓名'); return; }
    let obj = new AV.Object(STAFF_CLASS);
    obj.set('name', name);
    obj.set('department', department);
    obj.set('position', position);
    obj.set('baseSalary', baseSalary);
    await obj.save();
    hideAddStaffModal();
    await fetchStaffData();
    alert(`员工 ${name} 已添加`);
}
async function updateStaff(staffId) {
    const name = document.getElementById('staff-name').value;
    const department = document.getElementById('staff-department').value;
    const position = document.getElementById('staff-position').value;
    const baseSalary = parseFloat(document.getElementById('staff-base-salary').value) || 0;
    if (!name) { alert('请输入员工姓名'); return; }
    let obj = AV.Object.createWithoutData(STAFF_CLASS, staffId);
    obj.set('name', name);
    obj.set('department', department);
    obj.set('position', position);
    obj.set('baseSalary', baseSalary);
    await obj.save();
    hideAddStaffModal();
    await fetchStaffData();
    alert(`员工 ${name} 信息已更新`);
}
async function deleteStaff(staffId) {
    if (!confirm('确定要删除该员工吗？')) return;
    let obj = AV.Object.createWithoutData(STAFF_CLASS, staffId);
    await obj.destroy();
    await fetchStaffData();
}
function renderStaffList(list) {
    const staffList = document.getElementById('staff-list');
    let arr = Array.isArray(list) ? list : staffData;
    staffList.innerHTML = '';
    arr.forEach(staff => {
        const staffItem = document.createElement('div');
        staffItem.className = 'staff-item';
        staffItem.innerHTML = `
            <div class="staff-info">
                <div style="font-size: 18px; font-weight: bold;">${staff.name}</div>
                <div style="color: #666;">${staff.department || ''} - ${staff.position || ''}</div>
                <div style="color: #666;">基本工资：${staff.baseSalary || 0} 元</div>
            </div>
            <div class="staff-actions">
                <button onclick="editStaff('${staff.objectId}')">
                    <i class="material-icons">edit</i> 编辑
                </button>
                <button class="delete-btn" onclick="deleteStaff('${staff.objectId}')">
                    <i class="material-icons">delete</i> 删除
                </button>
            </div>
        `;
        staffList.appendChild(staffItem);
    });
    document.getElementById('staff-count').textContent = arr.length;
}
function editStaff(staffId) {
    const staff = staffData.find(s => s.objectId === staffId);
    if (!staff) return;
    document.getElementById('staff-modal-title').textContent = '编辑员工信息';
    document.getElementById('staff-name').value = staff.name || '';
    document.getElementById('staff-department').value = staff.department || '';
    document.getElementById('staff-position').value = staff.position || '';
    document.getElementById('staff-base-salary').value = staff.baseSalary || '';
    document.getElementById('save-staff-btn').setAttribute('onclick', `updateStaff('${staff.objectId}')`);
    document.getElementById('add-staff-modal').style.display = 'flex';
    currentEditingStaffId = staffId;
}
function showAddStaffModal() {
    document.getElementById('staff-modal-title').textContent = '添加新员工';
    document.getElementById('staff-name').value = '';
    document.getElementById('staff-department').value = '技术部';
    document.getElementById('staff-position').value = '';
    document.getElementById('staff-base-salary').value = '';
    document.getElementById('save-staff-btn').setAttribute('onclick', 'addStaff()');
    document.getElementById('add-staff-modal').style.display = 'flex';
}
function hideAddStaffModal() {
    document.getElementById('add-staff-modal').style.display = 'none';
    currentEditingStaffId = null;
}
function searchStaff() {
    const query = document.getElementById('staff-search').value.toLowerCase();
    if (!query) { renderStaffList(); return; }
    const filtered = staffData.filter(staff =>
        (staff.name || '').toLowerCase().includes(query) ||
        (staff.department || '').toLowerCase().includes(query) ||
        (staff.position || '').toLowerCase().includes(query)
    );
    renderStaffList(filtered);
}

/********** 考勤相关 ***********/
function getDaysInMonth(year, month) { return new Date(year, month, 0).getDate(); }
async function fetchAttendanceData(year, month) {
    const ym = year + '-' + (month.toString().padStart(2, '0'));
    const query = new AV.Query(ATTENDANCE_CLASS);
    query.equalTo('ym', ym);
    query.limit(1000);
    const results = await query.find();
    attendanceData[ym] = attendanceData[ym] || {};
    results.forEach(record => {
        let o = lc2obj(record);
        let staffId = o.staffId;
        let day = o.day;
        attendanceData[ym][staffId] = attendanceData[ym][staffId] || {};
        attendanceData[ym][staffId][day] = o.data || {};
    });
}
async function saveAttendanceCell(year, month, staffId, day, data) {
    const ym = year + '-' + (month.toString().padStart(2, '0'));
    const query = new AV.Query(ATTENDANCE_CLASS);
    query.equalTo('ym', ym);
    query.equalTo('staffId', staffId);
    query.equalTo('day', day);
    const res = await query.first();
    if (!res) {
        let obj = new AV.Object(ATTENDANCE_CLASS);
        obj.set('ym', ym);
        obj.set('staffId', staffId);
        obj.set('day', day);
        obj.set('data', data);
        await obj.save();
    } else {
        res.set('data', data);
        await res.save();
    }
    attendanceData[ym] = attendanceData[ym] || {};
    attendanceData[ym][staffId] = attendanceData[ym][staffId] || {};
    attendanceData[ym][staffId][day] = data;
}
async function loadAttendanceTable() {
    let year = parseInt(document.getElementById('year-select').value);
    let month = parseInt(document.getElementById('month-select').value);
    await fetchAttendanceData(year, month);
    const staff = staffData;
    const daysInMonth = getDaysInMonth(year, month);
    const ym = year + '-' + month.toString().padStart(2, '0');

    const thead = document.querySelector('#attendance-table thead');
    thead.innerHTML = '';
    thead.innerHTML += `<tr style="background:#f2f7fc;">
        <th colspan="${2 + staff.length * 3}" style="font-size:18px;font-weight:bold;text-align:center;">
            ${companyName} ${year}年${month}月考勤表
        </th>
    </tr>`;
    let headerRow1 = `<tr>
        <th rowspan="2" class="date" style="text-align:center;vertical-align:middle;font-size:15px;">日期</th>
        <th rowspan="2" class="week" style="text-align:center;vertical-align:middle;font-size:15px;">星期</th>`;
    staff.forEach(staff => { headerRow1 += `<th colspan="3" class="staff-title" style="text-align:center;">${staff.name}</th>`; });
    headerRow1 += '</tr>';
    let headerRow2 = '<tr>';
    staff.forEach(() => {
        headerRow2 += `
            <th class="am" style="text-align:center;">上午</th>
            <th class="pm" style="text-align:center;">下午</th>
            <th class="ot" style="text-align:center;">加班</th>
        `;
    });
    headerRow2 += '</tr>';
    thead.innerHTML += headerRow1 + headerRow2;

    const tbody = document.querySelector('#attendance-table tbody');
    tbody.innerHTML = '';
    const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
    for (let day = 1; day <= daysInMonth; day++) {
        const tr = document.createElement('tr');
        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const dateObj = new Date(year, month - 1, day);
        const dayOfWeek = dateObj.getDay();
        let isHoliday = holidays[dateStr];
        let isSunday = dayOfWeek === 0;
        let isMakeUpWork = dateStr === makeUpWorkDay;
        if (isHoliday || isSunday) tr.style.background = "#e8fce8";
        const dateCell = document.createElement('td');
        dateCell.textContent = dateStr;
        dateCell.className = 'date';
        dateCell.style.backgroundColor = '#fff';
        dateCell.style.textAlign = 'center';
        dateCell.style.verticalAlign = 'middle';
        tr.appendChild(dateCell);

        const weekCell = document.createElement('td');
        weekCell.className = 'week';
        weekCell.style.backgroundColor = '#fff';
        weekCell.style.textAlign = 'center';
        weekCell.style.verticalAlign = 'middle';
        if (isMakeUpWork) {
            weekCell.innerHTML = `<span class="week-cell-wrap" style="display: block;text-align:center;">星期${weekDays[dayOfWeek]}<span class="badge-ban">班</span></span>`;
        } else {
            weekCell.innerHTML = `<span class="week-cell-wrap" style="display: block;text-align:center;">星期${weekDays[dayOfWeek]}</span>`;
        }
        tr.appendChild(weekCell);

        staff.forEach(staffObj => {
            let staffKq = (attendanceData[ym] && attendanceData[ym][staffObj.objectId] && attendanceData[ym][staffObj.objectId][day.toString().padStart(2, '0')]) || {};
            ['am', 'pm', 'ot'].forEach((period, idx) => {
                let cell = document.createElement('td');
                cell.className = ['am', 'pm', 'ot'][idx];
                cell.classList.add('attendance-cell');
                cell.setAttribute('data-date', dateStr);
                cell.setAttribute('data-staff', staffObj.objectId);
                cell.setAttribute('data-period', period);
                cell.style.textAlign = 'center';
                cell.style.verticalAlign = 'middle';

                if (period === 'ot') {
                    cell.textContent = staffKq.ot ? staffKq.ot + 'h' : '';
                    cell.style.color = staffKq.ot ? '#d63031' : '';
                    cell.style.fontWeight = staffKq.ot ? 'bold' : '';
                    cell.onclick = async function () {
                        await setOvertime(cell);
                    }
                } else {
                    if (isHoliday) {
                        cell.textContent = holidays[dateStr];
                        cell.style.background = "#e8fce8";
                    } else if (isSunday && !isMakeUpWork) {
                        cell.textContent = '';
                        cell.style.background = "#e8fce8";
                    } else {
                        if (typeof staffKq[period] !== 'undefined') {
                            cell.textContent = staffKq[period];
                            cell.classList.remove('leave', 'pleaseleave', 'overtime');
                            cell.style.background = '';
                            cell.style.color = '';
                            cell.style.fontWeight = '';
                            if (staffKq[period] === '休') {
                                cell.classList.add('leave');
                                cell.style.background = '#FFFF00';
                                cell.style.color = '#d63031';
                                cell.style.fontWeight = 'bold';
                            } else if (staffKq[period] === '请假') {
                                cell.classList.add('pleaseleave');
                                cell.style.background = '#FFFF00';
                            } else if (staffKq[period] === '加班') {
                                cell.classList.add('overtime');
                                cell.style.color = '#d63031';
                                cell.style.fontWeight = 'bold';
                            }
                        } else {
                            cell.textContent = '√';
                            cell.style.background = '';
                            cell.style.color = '';
                            cell.style.fontWeight = '';
                        }
                    }
                    cell.onclick = async function () {
                        await toggleAttendance(cell);
                    }
                }
                tr.appendChild(cell);
            });
        });
        tbody.appendChild(tr);
    }
    generateSummaryRow();
    const signatureRow = document.getElementById('signature-row');
    signatureRow.innerHTML = '<td colspan="2">签字</td>';
    staff.forEach(() => { signatureRow.innerHTML += '<td colspan="3"></td>'; });
    document.getElementById('staff-count').textContent = staff.length;
}

async function toggleAttendance(cell) {
    const states = ['√', '休',  '加班'];
    let currentState = cell.textContent;
    let nextIndex = (states.indexOf(currentState) + 1) % states.length;
    cell.textContent = states[nextIndex];
    cell.classList.remove('holiday', 'leave', 'pleaseleave', 'overtime');
    if (cell.textContent === '休') cell.classList.add('leave');
    else if (cell.textContent === '加班') cell.classList.add('overtime');
    else if (cell.textContent === '请假') cell.classList.add('pleaseleave');
    const dateStr = cell.getAttribute('data-date');
    const staff = cell.getAttribute('data-staff');
    const period = cell.getAttribute('data-period');
    const [y,m,d] = dateStr.split('-');
    const ym = y+'-'+m;
    let nowCellData = attendanceData[ym] && attendanceData[ym][staff] && attendanceData[ym][staff][d] || {}
    nowCellData[period] = cell.textContent;
    await saveAttendanceCell(y, m, staff, d, nowCellData);
    generateSummaryRow();
}
async function setOvertime(cell) {
    const hours = prompt('请输入加班小时数:', '');
    const dateStr = cell.getAttribute('data-date');
    const staff = cell.getAttribute('data-staff');
    const period = cell.getAttribute('data-period');
    const [y,m,d] = dateStr.split('-');
    const ym = y+'-'+m;
    let nowCellData = attendanceData[ym] && attendanceData[ym][staff] && attendanceData[ym][staff][d] || {}
    nowCellData[period] = hours && !isNaN(hours) ? parseFloat(hours) : '';
    await saveAttendanceCell(y, m, staff, d, nowCellData);
    cell.textContent = hours && !isNaN(hours) ? `${hours}h` : '';
    if (hours) cell.classList.add('overtime');
    else cell.classList.remove('overtime');
    generateSummaryRow();
}
function generateSummaryRow() {
    const summaryRow = document.getElementById('summary-row');
    summaryRow.innerHTML = '<td colspan="2">汇总</td>';
    const year = parseInt(document.getElementById('year-select').value);
    const month = parseInt(document.getElementById('month-select').value);
    const daysInMonth = getDaysInMonth(year, month);
    const ym = year + '-' + month.toString().padStart(2, '0');
    let staffArr = staffData;
    let attData = attendanceData[ym] || {};
    staffArr.forEach(staff => {
        let leaveCount = 0;
        let normalWorkCount = 0;
        let addWorkCount = 0;
        let normalOtHours = 0;
        let sundayAddWorkCount = 0;
        for (let day = 1; day <= daysInMonth; day++) {
            const d = day.toString().padStart(2, '0');
            let rec = attData[staff.objectId] && attData[staff.objectId][d] || {};
            let dt = new Date(year, month - 1, day);
            let isSunday = dt.getDay() === 0;
            ['am', 'pm'].forEach(period => {
                if (rec[period] === '休') leaveCount += 0.5;
                if (rec[period] === '√' || typeof rec[period] === 'undefined' || rec[period] === '') normalWorkCount += 0.5;
                if (rec[period] === '加班') {
                    addWorkCount += 0.5;
                    if (isSunday) sundayAddWorkCount += 0.5;
                }
            });
            if (rec.ot && !isSunday) {
                let h = parseFloat(String(rec.ot).replace(/[^0-9.]/g, '')) || 0;
                normalOtHours += h;
            }
        }
        let fullAttendance = (leaveCount - sundayAddWorkCount) <= 0;
        let front = `${staff.name}：本月请假${leaveCount}天，平日加班${normalOtHours}小时，`;
        let back = `周日加班${sundayAddWorkCount}天，本月上班${(normalWorkCount + addWorkCount)}天${fullAttendance ? "，满勤" : ""}`;
        summaryRow.innerHTML += `<td colspan="3" style="line-height:1.8;">${front}<br>${back}</td>`;
    });
}

// 工资相关
function renderSalarySelect() {
    const ysel = document.getElementById('salary-year-select');
    const msel = document.getElementById('salary-month-select');
    if (!ysel || !msel) return;
    ysel.innerHTML = '';
    msel.innerHTML = '';
    for (let y = 2020; y <= 2030; y++) { ysel.innerHTML += `<option value="${y}">${y}</option>`; }
    for (let m = 1; m <= 12; m++) { msel.innerHTML += `<option value="${m}">${m}月</option>`; }
    const now = new Date();
    ysel.value = now.getFullYear();
    msel.value = now.getMonth() + 1;
}
async function renderSalaryPage() {
    renderSalarySelect();
    await renderSalaryTable();
}
async function fetchSalaryData(year, month) {
    salaryData = {};
    const query = new AV.Query(SALARY_CLASS);
    query.equalTo('year', parseInt(year));
    query.equalTo('month', parseInt(month));
    const results = await query.find();
    results.forEach(record => {
        let o = lc2obj(record);
        const key = `${year}-${month}-${o.staffId}`;
        salaryData[key] = o;
    });
}
async function renderSalaryTable() {
    const staffArr = staffData;
    const year = document.getElementById('salary-year-select').value;
    const month = document.getElementById('salary-month-select').value;
    await fetchSalaryData(year, month);
    const tbody = document.querySelector('#salary-table tbody');
    tbody.innerHTML = '';
   for (const staff of staffArr) {
    const sdKey = `${year}-${month}-${staff.objectId}`;
    const kq = await calcAttendanceDeduct(year, month, staff.objectId);
    let perf = salaryData[sdKey]?.performance || 0;
    let allow = salaryData[sdKey]?.allowance || 0;
    let baseSalary = staff.baseSalary || 0;
    let actualSalary = (Number(baseSalary) + Number(perf) + Number(allow) - Number(kq)).toFixed(2);
    tbody.innerHTML += `
            <tr>
              <td>${staff.name}</td>
              <td>${staff.department}</td>
              <td>${staff.position}</td>
              <td><input type="number" min="0" value="${baseSalary}" style="width:80px;text-align:right;"
                      onchange="updateBaseSalary('${staff.objectId}', this.value)" /></td>
              <td><input type="number" min="0" value="${perf}" style="width:80px;text-align:right;"
                      onchange="salaryData['${sdKey}'].performance=Number(this.value)||0;renderSalaryTable();" /></td>
              <td><input type="number" min="0" value="${allow}" style="width:80px;text-align:right;"
                      onchange="salaryData['${sdKey}'].allowance=Number(this.value)||0;renderSalaryTable();" /></td>
              <td><input type="number" min="0" value="${kq}" style="width:80px;text-align:right;" readonly /></td>
              <td style="font-weight:bold;">${actualSalary}</td>
            </tr>
        `;
  }
}
function updateBaseSalary(staffId, val) {
    const idx = staffData.findIndex(s => s.objectId === staffId);
    if (idx !== -1) staffData[idx].baseSalary = Number(val) || 0;
    renderSalaryTable();
}
async function calcAttendanceDeduct(year, month, staffId) {
    await fetchAttendanceData(year, month);
    const daysInMonth = getDaysInMonth(year, month);
    const ym = year+'-'+month.toString().padStart(2,'0');
    let attObj = attendanceData[ym] || {};
    let leaveDays = 0;
    for(let day=1; day<=daysInMonth; day++) {
        const d = day.toString().padStart(2,'0');
        let rec = attObj[staffId] && attObj[staffId][d];
        if(rec) {
            if(rec.am === '请假') leaveDays += 0.5;
            if(rec.pm === '请假') leaveDays += 0.5;
        }
    }
    return leaveDays*100;
}
function exportSalaryExcel() {
    renderSalaryTable();
    const table = document.getElementById('salary-table');
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    ws['!cols'] = [{ wch:12 },{ wch:14 },{ wch:16 },{ wch:12 },{ wch:10 },{ wch:10 },{ wch:12 },{wch:16}];
    XLSX.utils.book_append_sheet(wb, ws, "工资表");
    const year = document.getElementById('salary-year-select').value;
    const month = document.getElementById('salary-month-select').value;
    XLSX.writeFile(wb, `${companyName}${year}年${month}月工资表.xlsx`);
}

// 年/月选择
function renderYearSelect() {
    const yearSelect = document.getElementById('year-select');
    yearSelect.innerHTML = '';
    for (let y = 2020; y <= 2030; y++) {
        yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
    }
}
function setCurrentYearMonthSelect() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const yearSelect = document.getElementById('year-select');
    const monthSelect = document.getElementById('month-select');
    if (yearSelect && monthSelect) {
        yearSelect.value = year >= 2020 && year <= 2030 ? year : 2025;
        monthSelect.value = month;
    }
}
// Excel导入
function importExcel() {
    const fileInput = document.getElementById('excel-file');
    const files = fileInput.files;
    if (!files || !files.length) { alert('请选择一个或多个Excel文件'); return; }
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const sheetJson = XLSX.utils.sheet_to_json(worksheet, {header:1});
            let a1 = (sheetJson[0] && sheetJson[0][0]) ? sheetJson[0][0] : '';
            let year=2025, month=1;
            let match = a1.match(/^(.*?)\s*(\d{4})年(\d{1,2})月/);
            if(match) {
                year = parseInt(match[2]);
                month = parseInt(match[3]);
            }
            document.getElementById('year-select').value = year;
            document.getElementById('month-select').value = month;
            let msg = `即将导入文件：${file.name}
年份：${year} 月份：${month}
表格行数：${sheetJson.length}\n确定要录入当前数据吗？`;
            if(confirm(msg)) {
                await processImportedData(sheetJson, year, month);
                alert("数据导入成功！");
                await loadAttendanceTable();
            } else {
                alert("已取消本次文件导入！");
            }
        };
        reader.readAsArrayBuffer(file);
    });
}
async function processImportedData(sheetJson, year, month) {
    if(sheetJson.length<3) return;
    let header1 = sheetJson[0], header2 = sheetJson[1];
    let staffNames = [];
    for(let i=2; i<header2.length; i+=3) {
        let n = header1[i] || header1[i-1] || '';
        n = n.replace(/^\s+|\s+$/g,'');
        staffNames.push(n);
    }
    const staffArr = staffData;
    let ym = year+'-'+month.toString().padStart(2,'0');
    for(let r=2; r<sheetJson.length; r++) {
        let row = sheetJson[r];
        let dateStr = row[0];
        if(!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) continue;
        let d = dateStr.split('-')[2];
        for(let idx=0;idx<staffNames.length;idx++) {
            let staffName = staffNames[idx];
            let staffObj = staffArr.find(s=>s.name===staffName);
            if(!staffObj) continue;
            let sid = staffObj.objectId;
            let nowCellData = {};
            nowCellData.am = row[2+idx*3] || '';
            nowCellData.pm = row[2+idx*3+1] || '';
            let otcell = (row[2+idx*3+2]||'').toString();
            if(otcell && otcell.match(/\d/)) nowCellData.ot = parseFloat(otcell.replace(/[^\d\.]/g,'')) || 0;
            else nowCellData.ot = '';
            await saveAttendanceCell(year, month, sid, d, nowCellData);
        }
    }
}

// 页面切换和初始化（修正为async）
async function switchPage(pageId) {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.menu-item[data-page="${pageId}"]`).classList.add('active');
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    if(document.getElementById(pageId)) document.getElementById(pageId).classList.add('active');
    if(pageId==='attendance') { setCurrentYearMonthSelect(); await loadAttendanceTable(); }
    if(pageId==='staff') await fetchStaffData();
    if(pageId==='salary') await renderSalaryPage();
}
document.addEventListener('DOMContentLoaded',function(){
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', async function() {
            const pageId = this.getAttribute('data-page');
            await switchPage(pageId);
        });
    });
});
window.onload = function() {
  (async function() {
    renderYearSelect();
    renderSalarySelect();
    await fetchStaffData();
    setCurrentYearMonthSelect();
    await loadAttendanceTable();
    await renderSalaryPage();
  })();
};
  </script>
</body>

</html>
